<!DOCTYPE html>




<html
 dir="ltr"
 lang="en"
 >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content=#eeeeee>
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="shortcut icon" type="image/png"
           href="/favicon.png" 
    />
    <script defer src="https://unpkg.com/alpinejs@2.8.2/dist/alpine-ie11.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">
    
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Android app for NFC-powered eink display | DevPika’s Corner</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Android app for NFC-powered eink display" />
<meta name="author" content="Ayaskant Panigrahi" />
<meta property="og:locale" content="en" />
<meta name="description" content="Open-source Android app to update the batteryless eink display!" />
<meta property="og:description" content="Open-source Android app to update the batteryless eink display!" />
<link rel="canonical" href="https://devpika.github.io/2024/04/15/nfc-eink/" />
<meta property="og:url" content="https://devpika.github.io/2024/04/15/nfc-eink/" />
<meta property="og:site_name" content="DevPika’s Corner" />
<meta property="og:image" content="https://devpika.github.io/assets/images/blog/nfc-eink.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-15T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://devpika.github.io/assets/images/blog/nfc-eink.jpg" />
<meta property="twitter:title" content="Android app for NFC-powered eink display" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ayaskant Panigrahi"},"dateModified":"2024-04-15T00:00:00+00:00","datePublished":"2024-04-15T00:00:00+00:00","description":"Open-source Android app to update the batteryless eink display!","headline":"Android app for NFC-powered eink display","image":"https://devpika.github.io/assets/images/blog/nfc-eink.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://devpika.github.io/2024/04/15/nfc-eink/"},"url":"https://devpika.github.io/2024/04/15/nfc-eink/"}</script>
<!-- End Jekyll SEO tag -->

    <!-- head scripts --></head>

  <body>
    
        <section class="hero  is-small  is-bold is-primary" >
    <div class="hero-body ">
        <div class="container">
            <a href="https://devpika.github.io/"><h1 class="title is-size-2 has-text-dark has-text-weight-semibold">DevPika's Corner</h1></a>
            
        </div>
    </div>
</section>
    
    


    <section class="section main">
        <div class="container">
            <div class="columns is-multiline">
                
                <div class="column is-2-desktop is-2-tablet">
                    

<aside class="menu">

    
    <ul class="menu-list">
        
        <li>
            <a href="/" class=" pl-5 py-4 test">Home</a>
            
        </li>
        
        <li>
            <a href="/blog/" class=" pl-5 py-4 test">Blog</a>
            
        </li>
        
        <li>
            <a href="/about/" class=" pl-5 py-4 test">About</a>
            
        </li>
        
        <li>
            <a href="/projects/" class=" pl-5 py-4 test">Projects</a>
            
        </li>
        
        <li>
            <a href="/research/" class=" pl-5 py-4 test">Research</a>
            
        </li>
        
        <li>
            <a href="https://devpika.github.io/assets/Ayaskant_Panigrahi_CV.pdf" class=" pl-5 py-4 test">CV</a>
            
        </li>
            
    </ul>

</aside>
                </div>
                
                <div class="column is-8">
                    
                    
                    
                    
                    <div class="content custom-text-size">
    <h1 class="title is-3">Android app for NFC-powered eink display</h1>
    <p>Posted on Apr 15, 2024</p>

    

    <div class="tags">
      
        <a href="/tags/#Android">
          <span class="tag is-primary has-text-dark is-size-5 m-1">
            Android
          </span>
        </a>
      
        <a href="/tags/#C++">
          <span class="tag is-primary has-text-dark is-size-5 m-1">
            C++
          </span>
        </a>
      
    </div>

    <p>Open-source Android app to update the batteryless eink display!
<!--more--></p>

<p>I have a love-hate relationship with batteries - while they make our lives that much more convenient, they are hard to dispose and recycle. Even rechargeable batteries lose their capacity over time. When I came across <a href="https://hackaday.com/2023/12/18/hacking-an-nfc-e-paper-display-from-waveshare-with-mystery-mcu/">a Hackaday post about</a> mysterious eink / epaper devices from Waveshare that do not need a battery to run, I was intrigued. Of course, the idea behind this is energy harvesting, which isn’t anything ground breaking. But <a href="/projects/creative-doodles-p5js/">I love “hanko” / stamp-sized</a> displays and had been eyeing the 1.54” epaper displays for a while now, so I got my hands on <a href="https://www.waveshare.com/1.54inch-nfc-powered-e-paper-bw.htm">the 1.54” model</a>. As I was waiting for the unit to ship from China, I looked into driving these displays programmatically. The app provided by Waveshare was closed-source and the <a href="https://www.waveshare.com/wiki/Android_SDK_for_NFC-Powered_e-Paper">documentation for the Android SDK </a> to interact with these displays was sparse and confusing to say the least.</p>

<p>Luckily, folks from the open-source hacker / maker community had <a href="https://github.com/joshuatz/nfc-epaper-writer">experimented with making an app for the display</a> before me, so I forked the repo and got to work. With some clever app reverse-engineering and support(!) from Waveshare, I got the NFC library working even with my 1.54” display!</p>

<p>The next challenge before me was to effectively use the red channel that was specific to this model. To begin my tests, I tried pushing a pre-dithered image created in GIMP (and later, for good measure, even ImageMagick) to the display. I ran into unexpected trouble here: the image was garbled even if it was the exact dimensions and only contained red, black and white! Hoping to troubleshoot the image BMP format (“Perhaps it doesn’t want ARGB_8888 after all?!?”), I tried flashing some of the test images from the decompiled app, but the results were still garbled. At this point, I suspected one of the steps was altering the final bitmap that was getting flashed to the display, so I set this problem aside for now. It was time to dither the image programmatically.</p>

<p>A popular <a href="https://github.com/jeffreyliu8/Native-Floyd-Steinberg-Dithering">Floyd-Steinberg Dithering library for Android</a> only supported black and white colors. While a <a href="https://github.com/makew0rld/dither">Go dithering library</a> did what I wanted, it was a tedious process to create the JNI bindings. I took this as a learning opportunity. And thus it was time to fork the Android dithering library and add color dithering! I quickly put together the C++ native bits to get this working. Since all of this is open source, I could easily deploy the library using Jitpack, similar to the original author of the library. Waveshare provides some code using runners on their Android SDK page, so I added that in for some quick games on the stability side. Less ANRs = more fun!</p>

<p>The question remained though: what was changing the final bitmap that got flashed to the display, causing the image to get garbled? I experimented with the placing the dithering after the cropping library had done its work. <em>Et voilà</em>, the image displayed correctly! Digging into this, it looks like the <a href="https://github.com/CanHub/Android-Image-Cropper">Android Cropping library</a> might have been anti-aliasing the image, which caused intermediate colors to come up. With the final bits of the dithering puzzle in place, it was time to enjoy <a href="https://www.redbubble.com/i/poster/Initial-D-AE86-JDM-Mountain-Downhill-Night-Ride-Drift-Racing-Takumi-Fujiwara-by-cowtownCOWBOY/89779285.LVTDI">an Initial D poster</a> in all its 200x200, dithered glory:</p>

<p><img src="/assets/images/blog/nfc-eink.jpg" alt="WaveShare 1.54&quot; Passive NFC-Powered EInk Display, showing an image of car from Initial D anime" /></p>

<p>Made it this far? You can find all the code for the flashing app in the <a href="https://github.com/DevPika/nfc-epaper-writer-update">Github repo for the Android app</a> and my fork of the Android library with colored dithering <a href="https://github.com/DevPika/Native-Floyd-Steinberg-Dithering">here</a>. While the dithering code is a bit of mess considering it was written within a few hours over the weekend, an easy improvement would be to pass in a custom color palette (currently only supports the original BW and BWR schemes).</p>

</div>







                </div>
                <div class="column is-2-desktop is-2-tablet">
                    
<!-- some comment -->
<div class="card bio" style="border-radius: 9999px 9999px 6px 6px;" itemscope itemtype="https://schema.org/Person">

  
  <a href="https://devpika.github.io/">
    <figure class="image p-3">
      <img class="is-rounded grayscale" src="/assets/images/bio-photo.jpg" alt="Ayaskant Panigrahi" itemprop="image" class="u-photo">
    </figure>
  </a>
    

    <div class="card-content">
      <div class="content has-text-centered">
        <a class="title is-5 is-size-4" itemprop="name" href="https://devpika.github.io/">Ayaskant Panigrahi</a>
        
      </div>
      
        <div class="content">
          <p><p>Hopelessly in love with clean code and unobtrusive design!</p>
</p>
        </div>
      
      
        <div class="content">
          <p itemprop="description"><p>XR Developer &amp; Researcher</p>
</p>
        </div>
      
      <div class="content">
        
          <span class="icon-text" itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
            <span class="icon">
              <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i>
            </span>
            <span itemprop="name" class="p-locality">Vancouver</span>
          </span>
        

        
          
            
            <a href="https://twitter.com/devpika" rel="nofollow noopener noreferrer me" itemprop="sameAs">
              <span class="icon-text">
                <span class="icon">
                  <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i>
                </span>
                <span>Twitter</span>
              </span>
            </a>
            
          
            
            <a href="https://github.com/DevPika" rel="nofollow noopener noreferrer me" itemprop="sameAs">
              <span class="icon-text">
                <span class="icon">
                  <i class="fab fa-fw fa-github" aria-hidden="true"></i>
                </span>
                <span>GitHub</span>
              </span>
            </a>
            
          
            
            <a href="https://glitch.com/@gameshire" rel="nofollow noopener noreferrer me" itemprop="sameAs">
              <span class="icon-text">
                <span class="icon">
                  <i class="fas fa-link" aria-hidden="true"></i>
                </span>
                <span>Glitch</span>
              </span>
            </a>
            
          
            
            <a href="https://www.linkedin.com/in/ayaskant-panigrahi" rel="nofollow noopener noreferrer me" itemprop="sameAs">
              <span class="icon-text">
                <span class="icon">
                  <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i>
                </span>
                <span>LinkedIn</span>
              </span>
            </a>
            
          
            
            <a href="https://gameshire98.itch.io/" rel="nofollow noopener noreferrer me" itemprop="sameAs">
              <span class="icon-text">
                <span class="icon">
                  <i class="fab fa-fw fa-itch-io" aria-hidden="true"></i>
                </span>
                <span>itch.io</span>
              </span>
            </a>
            
          
            
            <a href="https://www.behance.net/ayaskant" rel="nofollow noopener noreferrer me" itemprop="sameAs">
              <span class="icon-text">
                <span class="icon">
                  <i class="fab fa-fw fa-behance-square" aria-hidden="true"></i>
                </span>
                <span>Behance</span>
              </span>
            </a>
            
          
            
          
        

        
          <a href="mailto:%61%79%61%73%6B%61%6E%74.%70%61%6E%69%67%72%61%68%69@%67%6D%61%69%6C.%63%6F%6D" rel="me" class="u-email">
            <span class="icon-text">
              <span class="icon">
                <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i>
              </span>
              <span>Email</span>
            </span>
          </a>
        
      </div>
    </div>
  </div>
</div>
                </div>
            </div>
        </div>
    </section>
    
        <footer class="footer py-3">
    <div class="container">
        
        

        <div class="content is-small has-text-centered is-vcentered">
            <p>&copy; 2024 Ayaskant Panigrahi. Created using the <a href="https://jenil.github.io/bulmaswatch/darkly/">Darkly theme</a>, <a href="https://github.com/chrisrhymes/bulma-clean-theme">Bulma Clean Gem</a> and <a href="https://jekyllrb.com/">Jekyll</a>.</p>
            <button class="button is-small ml-2" x-data @click="window.scrollTo({top: 0, behavior: 'smooth'})">Back to top</button>
        </div>
    </div>
        
</footer>
    
    <script src="/assets/js/app.js" type="text/javascript"></script><script>
    window.addEventListener("load", () => {
        const imgs = document.querySelectorAll("img.grayscale");
        imgs.forEach(element => {
            element.addEventListener('touchstart', function(e) {
                element.classList.toggle('hover_effect');
            });
            element.addEventListener('touchend', function(e) {
                element.classList.toggle('hover_effect');
            });
        });
    });
</script></body>
</html>
